# 환자 자동 메시지 생성 시스템

## 개요

환자 자동 메시지 생성 시스템은 치과 클리닉에서 상담 후 환자에게 맞춤형 메시지를 자동으로 생성하는 기능을 제공합니다. 이 시스템은 Supabase 데이터베이스, 웹 애플리케이션, 그리고 Make.com을 통한 AI 모델 연동으로 구성됩니다.

## 시스템 구성 요소

1. **데이터베이스 (Supabase)**
   - `message_generation` 테이블: 메시지 생성 요청과 결과를 저장
   - 웹훅 트리거: 메시지 생성 요청 시 Make.com으로 데이터 전송
   - 뷰: 메시지 생성 상태 모니터링을 위한 `message_generation_view`

2. **웹 애플리케이션**
   - PatientConsultation 컴포넌트: 환자 상담 기록에 메시지 생성 버튼 제공
   - 메시지 생성 요청 기능: `createMessageGenerationRequest` 함수
   - 메시지 상태 확인 및 표시 기능: 주기적으로 상태 확인 및 UI에 표시

3. **자동화 플랫폼 (Make.com)**
   - 웹훅 수신: Supabase에서 전송된 메시지 생성 요청 수신
   - AI 모델 연동: OpenAI 등의 AI 모델에 메시지 생성 요청
   - 결과 업데이트: 생성된 메시지를 Supabase에 저장

## 구현된 기능

1. **메시지 생성 요청**
   - 상담 기록 목록에서 메시지 생성 버튼 클릭
   - 환자 정보와 상담 정보를 수집하여 `message_generation` 테이블에 저장
   - 메시지 요청 상태를 실시간으로 UI에 표시

2. **웹훅 통합**
   - Supabase 데이터베이스에 트리거 설정
   - 메시지 생성 요청 시 Make.com으로 데이터 전송
   - 트리거 조건: `message_requested = true`로 설정될 때

3. **메시지 생성 및 저장**
   - AI 모델을 통한 맞춤형 환자 메시지 생성
   - 생성된 메시지를 `message_generation` 테이블에 저장
   - 메시지 생성 완료 시 `message_generated_at` 필드 업데이트

4. **메시지 조회 및 표시**
   - 생성된 메시지를 웹 애플리케이션에서 조회 가능
   - 모달 창을 통해 생성된 메시지 내용 확인
   - 메시지 생성 상태에 따른 UI 표시 (로딩, 완료, 오류)

## 설치 및 설정 방법

### 1. 데이터베이스 설정

1. Supabase 프로젝트의 SQL 에디터에서 `message_generation` 테이블 생성 스크립트 실행
2. `webhook_setup.sql` 파일의 내용을 SQL 에디터에서 실행하여 트리거 및 뷰 설정

### 2. 웹 애플리케이션 설정

1. `PatientConsultation.tsx` 파일에 메시지 생성 관련 코드가 모두 통합됨
2. 필요한 경우 테스트 스크립트 `test_message_generation.js` 활용

### 3. Make.com 설정

1. Make.com에서 시나리오 생성
2. `make_integration_guide.md` 문서에 따라 웹훅 및 AI 모델 연동 설정

## 테스트 방법

1. 상담 기록에서 메시지 생성 버튼 클릭
2. 콘솔에서 요청 상태 확인
3. Supabase 테이블에서 메시지 생성 상태 모니터링
4. Make.com에서 시나리오 실행 확인
5. 생성된 메시지 내용 확인

## 확장 및 개선 방향

- 메시지 템플릿 관리 기능 추가
- 다양한 메시지 타입 지원 (SMS, 카카오톡, 이메일 등)
- 메시지 발송 통계 및 분석 기능
- 환자 피드백 수집 및 메시지 품질 개선

## 문제 해결

문제가 발생했을 경우 다음을 확인하세요:

1. Supabase 데이터베이스 테이블 구조 및 트리거가 올바르게 설정되었는지 확인
2. Make.com 시나리오가 활성화되었는지 확인
3. 웹 애플리케이션의 콘솔에서 오류 메시지 확인
4. Supabase의 로그에서 트리거 실행 여부 확인
5. Make.com의 실행 기록에서 오류 메시지 확인

## 담당자

- 개발: [개발자 이름]
- 관리: [관리자 이름]
- 문의: [이메일 주소] 